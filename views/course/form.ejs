<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= course.name %> | PaperVault</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- CSS -->
  <link rel="stylesheet" href="/css/courseForm.css">
  <link rel="stylesheet" href="/css/homepage.css">
</head>
<body>

<!-- HEADER -->
<header class="pv-header">
  <div class="pv-header-container">
    <a href="/university" class="pv-brand">üìö PaperVault</a>

    <div class="pv-auth">
      <% if (!currentUser) { %>
        <a href="/login" class="pv-auth-link">Login</a>
        <a href="/register" class="pv-auth-link pv-register">Register</a>
      <% } else { %>
        <a href="/logout" class="pv-auth-link pv-logout">Logout</a>
      <% } %>
    </div>
  </div>
</header>

<main class="page-container">

  <!-- BACK -->
  <div class="top-back-link">
    <a href="/university/<%= uni._id %>" class="back-link">‚Üê Back to Courses</a>
  </div>

  <!-- COURSE HEADER -->
  <section class="course-header">
    <h1 class="course-title"><%= course.name %></h1>
    <p class="course-subtitle"><%= uni.name %></p>
  </section>

  <!-- FILTER CARD -->
  <section class="filter-card">
    <form action="/papers" method="GET">

      <input type="hidden" name="university" value="<%= uni._id %>">
      <input type="hidden" name="course" value="<%= course.name %>">

      <div class="row g-4">

        <!-- BRANCH -->
        <div class="col-md-4">
          <label id="branch-label" class="form-label">Branch</label>
          <select id="branch" name="branch" class="form-select" required>
            <option value="">Select</option>
          </select>
        </div>

        <!-- YEAR -->
        <div class="col-md-4">
          <label class="form-label">Year</label>
          <select id="year" name="year" class="form-select" required>
            <option value="">Select Year</option>
          </select>
        </div>

        <!-- SEM -->
        <div class="col-md-4">
          <label class="form-label">Semester</label>
          <select id="semester" name="semester" class="form-select" required>
            <option value="">Select Semester</option>
          </select>
        </div>

        <!-- SUBJECT -->
        <div class="col-md-12">
          <label class="form-label">Subject</label>
          <select id="subject" name="subject" class="form-select" required>
            <option value="">Select Subject</option>
          </select>
        </div>

      </div>

      <!-- ACTIONS -->
      <div class="form-actions mt-4">
        <% if (currentUser) { %>
          <button type="submit" class="btn btn-primary">View Papers</button>
          <a
            href="/papers/upload?university=<%= uni._id %>&course=<%= course.name %>"
            class="btn btn-outline-primary"
          >
            Upload Paper
          </a>
        <% } else { %>
          <a href="/login" class="btn btn-primary">Login to View Papers</a>
          <a href="/login" class="btn btn-outline-primary">Login to Upload</a>
        <% } %>
      </div>

    </form>
  </section>

</main>

<!-- SUBJECT DATA -->
<script type="application/json" id="subject-data">
  <%- JSON.stringify(subjectData) %>
</script>

<script>
  const subjectData = JSON.parse(
    document.getElementById("subject-data").textContent
  );

  const courseName = "<%= course.name %>";
  const branchSelect = document.getElementById("branch");
  const yearSelect = document.getElementById("year");
  const semSelect = document.getElementById("semester");
  const subjectSelect = document.getElementById("subject");
  const branchLabel = document.getElementById("branch-label");

  /* LABEL MAP */
  const labelMap = {
    BTech: "Branch",
    MTech: "Specialization",
    MBA: "Specialization",
    MCA: "Track",
    DualDegree: "Branch",
    BPharma: "Branch",
    MPharma: "Specialization",
    Polytechnic: "Branch",
    PhD: "Domain"
  };

  if (labelMap[courseName]) {
    branchLabel.textContent = labelMap[courseName];
  }

  /* COURSE ‚Üí YEARS MAP */
 const courseYearMap = {
  // Engineering & Technology
  BTech: 4,
  MTech: 2,
  MCA: 2,
  DualDegree: 5,
  Polytechnic: 3,

  // Management
  MBA: 2,

  // Pharmacy
  BPharma: 4,
  MPharma: 2,

  // Science
  BSc: 3,
  MSc: 2,

  // Arts
  BA: 3,
  MA: 2,

  // Commerce
  BCom: 3,
  MCom: 2,

  // Research
  PhD: 4
};


  /* LOAD BRANCHES */
  if (subjectData[courseName]) {
    Object.keys(subjectData[courseName]).forEach(branch => {
      if (branch === "__COMMON__") return;
      const opt = document.createElement("option");
      opt.value = branch;
      opt.textContent = branch;
      branchSelect.appendChild(opt);
    });
  }

  /* POPULATE YEARS */
  function populateYears() {
    yearSelect.innerHTML = "<option value=''>Select Year</option>";
    semSelect.innerHTML = "<option value=''>Select Semester</option>";
    subjectSelect.innerHTML = "<option value=''>Select Subject</option>";

    const totalYears = courseYearMap[courseName];
    if (!totalYears) return;

    for (let i = 1; i <= totalYears; i++) {
      const suffix =
        i === 1 ? "st" :
        i === 2 ? "nd" :
        i === 3 ? "rd" : "th";

      const opt = document.createElement("option");
      opt.value = `${i}${suffix}`;
      opt.textContent = `${i}${suffix}`;
      yearSelect.appendChild(opt);
    }
  }

  /* POPULATE SEMESTERS */
  function populateSemesters() {
    semSelect.innerHTML = "<option value=''>Select Semester</option>";
    subjectSelect.innerHTML = "<option value=''>Select Subject</option>";

    const year = yearSelect.value;
    if (!year) return;

    const yearNum = parseInt(year);
    const sem1 = yearNum * 2 - 1;
    const sem2 = yearNum * 2;

    [sem1, sem2].forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      semSelect.appendChild(opt);
    });
  }

  /* UPDATE SUBJECTS */
  function updateSubjects() {
    subjectSelect.innerHTML = "<option value=''>Select Subject</option>";

    const branch = branchSelect.value;
    const year = yearSelect.value;
    const sem = semSelect.value;

    let subjects = [];

    if (
      subjectData[courseName]?.__COMMON__ &&
      subjectData[courseName].__COMMON__[year]?.[sem]
    ) {
      subjects = subjects.concat(
        subjectData[courseName].__COMMON__[year][sem]
      );
    }

    if (
      subjectData[courseName]?.[branch]?.[year]?.[sem]
    ) {
      subjects = subjects.concat(
        subjectData[courseName][branch][year][sem]
      );
    }

    [...new Set(subjects)].forEach(sub => {
      const opt = document.createElement("option");
      opt.value = sub;
      opt.textContent = sub;
      subjectSelect.appendChild(opt);
    });
  }

  /* EVENTS */
  populateYears();
  yearSelect.addEventListener("change", populateSemesters);
  branchSelect.addEventListener("change", updateSubjects);
  semSelect.addEventListener("change", updateSubjects);
</script>

</body>
</html>




